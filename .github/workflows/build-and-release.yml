name: Build and Release

on:
  push:
    branches:
      - main
    paths:
      - "normalize_music.py"
      - "normalize_music.spec"
      - "version_info.txt"
      - ".github/workflows/build-and-release.yml"
  workflow_dispatch:

permissions:
  contents: write
  releases: write

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.13"
          cache: pip

      - name: Cache pip packages
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller

      - name: Download ffmpeg
        shell: pwsh
        run: |
          Write-Host "Starting FFmpeg download..."
          try {
            $ProgressPreference = 'SilentlyContinue'
            Invoke-WebRequest -Uri "https://github.com/BtbN/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-win64-gpl.zip" -OutFile "ffmpeg.zip"
            Write-Host "âœ“ FFmpeg zip downloaded successfully"
            
            Write-Host "Extracting FFmpeg..."
            Expand-Archive -Path "ffmpeg.zip" -DestinationPath "." -Force
            Write-Host "âœ“ FFmpeg extracted"
            
            Write-Host "Looking for ffmpeg.exe..."
            $ffmpeg_path = Get-ChildItem -Recurse -Filter "ffmpeg.exe" | Select-Object -First 1
            if ($null -eq $ffmpeg_path) {
              throw "ffmpeg.exe not found in archive!"
            }
            
            Write-Host "Copying ffmpeg.exe to current directory..."
            Copy-Item $ffmpeg_path.FullName -Destination "ffmpeg.exe" -Force
            Write-Host "âœ“ FFmpeg copied to: $(Get-Location)\ffmpeg.exe"
            
            Write-Host "Cleaning up..."
            Remove-Item "ffmpeg.zip" -Force
            Get-ChildItem -Directory -Filter "*ffmpeg*" | Remove-Item -Recurse -Force
            Write-Host "âœ“ Cleanup complete"
          }
          catch {
            Write-Error "FFmpeg download failed: $_"
            exit 1
          }

      - name: Build executable with PyInstaller
        shell: pwsh
        run: |
          Write-Host "Starting PyInstaller build..."
          Write-Host "Python version: $(python --version)"
          Write-Host "PyInstaller version: $(python -m PyInstaller --version)"
          Write-Host "Current directory: $(Get-Location)"
          Write-Host "Files in current directory:"
          Get-ChildItem | Where-Object {$_.Name -match "normalize|ffmpeg"} | ForEach-Object { Write-Host "  - $($_.Name)" }
          
          python -m PyInstaller normalize_music.spec --clean -y
          if ($LASTEXITCODE -ne 0) {
            Write-Error "PyInstaller build failed with exit code $LASTEXITCODE"
            exit $LASTEXITCODE
          }
          Write-Host "âœ“ Build completed successfully"

      - name: Check build output
        shell: pwsh
        run: |
          Write-Host "Checking build output..."
          Write-Host "Current directory: $(Get-Location)"
          
          if (Test-Path "dist") {
            Write-Host "âœ“ dist/ directory exists"
            Get-ChildItem dist -Recurse | ForEach-Object { Write-Host "  - $($_.FullName)" }
          } else {
            Write-Error "dist/ directory not found!"
            exit 1
          }
          
          if (-Not (Test-Path "dist\normalize_music.exe")) {
            Write-Error "Build failed: normalize_music.exe not found"
            exit 1
          }
          
          $file = Get-Item "dist\normalize_music.exe"
          $size = $file.Length / 1MB
          Write-Host "âœ“ Build successful!"
          Write-Host "  File: $($file.Name)"
          Write-Host "  Size: $([Math]::Round($size, 2)) MB"
          Write-Host "  Path: $($file.FullName)"

      - name: Create Release
        if: success()
        uses: softprops/action-gh-release@v2
        with:
          files: dist/normalize_music.exe
          tag_name: v${{ github.run_number }}
          name: "Release v${{ github.run_number }}"
          body: |
            ## ðŸŽµ Music Normalizer Build

            **Build Info:**
            - Commit: ${{ github.sha }}
            - Trigger: ${{ github.event_name }}
            - Build Number: ${{ github.run_number }}

            **Files included:**
            - `normalize_music.exe` - Standalone executable (no installation required)

            **What's new:**
            - Multi-threaded audio/video loudness normalization
            - Supports MP3, FLAC, WAV, M4A, OGG, OPUS, AAC, WMA, MP4, MKV, AVI, MOV, WMV, FLV, WEBM
            - Two-pass loudness normalization to prevent clipping
            - Automatic FFmpeg detection

            **Usage:**
            1. Download `normalize_music.exe`
            2. Place it in your music folder
            3. Run it and select your target loudness level
            4. Click "Avvia Normalizzazione"
            5. Normalized files will be saved in `normalized/` subfolder
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ github.token }}
